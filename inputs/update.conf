# vlems - Virtual LEMS
# "your own system administrator"

# vi:ft=cfengine:
##########################################################################
#                                                                        #
#                           update.conf                                  #
#                                                                        #
# This script distributes the configuration, a simple file so that,      #
# if there are syntax errors in the main config, we can still            #
# distribute a correct configuration to the machines afterwards, even    #
# though the main config won't parse. It is read and run just before the #
# main configuration is parsed.                                          #
#                                                                        #
# This is only for distributing the files to the client. All other       #
# actions are defined in cfagent.conf                                    #
#                                                                        #
##########################################################################

groups:
    # try not to rely much on DNS here. This script will be use outside of our
    # internal network as well...
    CfengineServers = ( wiz 10_1_1_6 2007_a_b__6 www_kiskeyix_org 66_114_86_65  )
    unix = ( linux )

control:
    
    any::
        AllowRedefinitionOf = ( 
            cfengine_server domain master_cfinput
            )

        sysadm  = ( lemsx1@gmail.com )

        actionsequence  = ( copy processes tidy shellcommands )  # Keep this simple and constant

        TrustKeysFrom = ( wiz CfengineServers ) 

        master_cfmodules  = ( /var/cfengine/vlems/modules ) 

        # these classes new_* are define= when creating a new self-contained environment
        AddInstallable = ( new_cfenvd new_cfservd new_cfexecd )

        domain          = ( kiskeyix.org )  # Needed for remote copy ( hint:  ExecResult(/bin/domainname) ). See gethostbyaddr()
    !CfengineServers::
        cfengine_server = ( 66.114.86.65 )
    
    CfengineServers::
        cfengine_server = ( localhost )

    any::
        master_cfinput  = ( /var/cfengine/vlems/inputs ) 

    # Some convenient variables
    unix.!debian::
        workdir     = ( /var/cfengine )

    debian::
        workdir     = ( /var/lib/cfengine2 )

    unix::
        cf_install_dir  = ( /usr/sbin )

###################################################################
#
# Spread the load, make sure the servers get done first though
#
###################################################################

    !CfengineServers::

        SplayTime = ( 15 ) # cfagent/cfexecd sleep for 1-5 minutes (random) to avoid load issues

############################################################################

#
# Make sure there is a local copy of the configuration and
# the most important binaries in case we have no connectivity
# e.g. for mobile stations or during DOS attacks
#

copy:
    !CfengineServers::
        $(master_cfinput)               dest=$(workdir)/inputs
                                        r=inf
                                        mode=600
                                        type=binary
                                        exclude=*.lst
                                        exclude=*.swp
                                        exclude=*~
                                        exclude=#*
                                        ignore=CVS
                                        ignore=.svn
                                        ignore=.git
                                        server=$(cfengine_server)
                                        trustkey=true

        $(master_cfmodules)             dest=$(workdir)/modules
                                        r=inf
                                        mode=700
                                        type=binary
                                        exclude=*.lst
                                        exclude=*.swp
                                        exclude=*~
                                        exclude=#*
                                        ignore=CVS
                                        ignore=.svn
                                        ignore=.git
                                        server=$(cfengine_server)
                                        trustkey=true
                                        purge=true
    CfengineServers::
        $(master_cfinput)               dest=$(workdir)/inputs
                                        r=inf
                                        mode=600
                                        type=binary
                                        exclude=*.lst
                                        exclude=*.swp
                                        exclude=*~
                                        exclude=#*
                                        ignore=CVS
                                        ignore=.svn
                                        ignore=.git
                                        trustkey=true

        $(master_cfmodules)             dest=$(workdir)/modules
                                        r=inf
                                        mode=700
                                        type=binary
                                        exclude=*.lst
                                        exclude=*.swp
                                        exclude=*~
                                        exclude=#*
                                        ignore=CVS
                                        ignore=.svn
                                        ignore=.git
                                        trustkey=true
                                        purge=true

        # makes a self-contained environment for running cfengine:
    unix::

        $(cf_install_dir)/cfagent    dest=$(workdir)/bin/cfagent 
                                      mode=755  
                                      backup=false
                                      type=checksum

        $(cf_install_dir)/cfservd    dest=$(workdir)/bin/cfservd
                                      mode=755
                                      backup=false
                                      type=checksum
                                      define=new_cfservd

        $(cf_install_dir)/cfexecd    dest=$(workdir)/bin/cfexecd
                                      mode=755  
                                      backup=false
                                      type=checksum
                                      define=new_cfexecd

        $(cf_install_dir)/cfenvd     dest=$(workdir)/bin/cfenvd
                                      mode=755  
                                      backup=false
                                      type=checksum
                                      define=new_cfenvd

#####################################################################

tidy:

#
# Cfexecd stores output in this directory.
# Make sure we don't build up files and choke on our own words!
#
    $(workdir)/outputs pattern=* age=14

#####################################################################


# lastly, make sure that cfengine is running properly on all systems

shellcommands:
    "/bin/echo '*/15 * * * * root /var/lib/cfengine2/bin/cfagent -q' > /etc/cron.d/vlems" ifelapsed=1440

# processes:
# 
#     unix::
#         "cfenvd"    restart     "/etc/init.d/cfengine2 restart"
# 
#         "cfservd"   restart     "/etc/init.d/cfengine2 restart"
# 
#         "cfexecd"   restart     "/etc/init.d/cfengine2 restart"

